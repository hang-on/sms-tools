<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sega Master System – Image Viewer & Palette Converter</title>
  <style>
    :root{--bg:#0b0d10;--panel:#12161b;--muted:#a7b0be;--accent:#2dd4bf;--border:#1f2937}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:var(--bg);color:#e5e7eb}
    header{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:14px}
    header h1{font-size:18px;margin:0;font-weight:650;letter-spacing:.2px}
    header .sub{color:var(--muted);font-size:12px}
    main{padding:16px;display:grid;grid-template-columns:320px 1fr;gap:16px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .left{padding:14px}
    .controls{display:flex;flex-direction:column;gap:10px}
    .drop{border:1.5px dashed #334155;border-radius:12px;padding:16px;text-align:center;color:var(--muted);background:#0f1318}
    .drop.drag{border-color:var(--accent);color:#d1fae5}
    input[type=file]{width:100%}
    button{appearance:none;border:1px solid #334155;background:#0f172a;color:#e5e7eb;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:600}
    button.primary{background:var(--accent);border-color:transparent;color:#041214}
    button:disabled{opacity:.5;cursor:not-allowed}
    label{font-size:12px;color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .toggle{display:flex;gap:8px;align-items:center}
    .palette{display:grid;grid-template-columns:repeat(8, 1fr);gap:2px;margin-top:8px}
    .palette.used{grid-template-columns:repeat(auto-fill, minmax(16px, 1fr));gap:4px}
    .sw{height:16px;border-radius:3px;border:1px solid rgba(255,255,255,.05)}
    .sw.used{height:18px}
    .gallery{display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:16px}
    .panel{border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .panel h3{margin:0;padding:10px 12px;border-bottom:1px solid var(--border);background:#0e1319;font-size:13px;color:#cbd5e1}
    .panel .body{padding:12px}
    canvas{width:100%;height:auto;image-rendering:pixelated;background:#000}
    .meta{display:flex;gap:10px;flex-wrap:wrap;color:#a7b0be;font-size:12px;margin-top:8px}
    .kbd{background:#0b1220;border:1px solid #1f2937;padding:1px 6px;border-radius:6px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    footer{padding:10px 16px;color:#94a3b8;border-top:1px solid var(--border);font-size:12px}
    a{color:#93c5fd}
    details.test summary{cursor:pointer}
    .ok{color:#10b981}
    .fail{color:#f87171}
  </style>
</head>
<body>
  <div id="bootBanner" style="position:fixed;inset:auto 16px 16px 16px;background:#111827;color:#e5e7eb;border:1px solid #374151;border-radius:10px;padding:8px 10px;font:12px/1.2 ui-sans-serif,system-ui">Preview loaded. If this box stays forever, JS didn't run—check the Self-test panel for errors.</div>
  <header class="card">
    <h1>SMS Image Viewer & Palette Converter</h1>
    <span class="sub">Single‑file HTML • Converts any PNG to Sega Master System’s 64‑color palette and saves a <strong>paletted (indexed) PNG</strong></span>
  </header>

  <main>
    <section class="left card">
      <div class="controls">
        <div class="drop" id="drop">
          <div><strong>Drop a PNG here</strong> or use the file picker</div>
          <div class="meta">Tip: Also works with JPG/GIF/BMP, but PNG is recommended.</div>
        </div>
        <input id="file" type="file" accept="image/*" />

        <div class="row">
          <div class="toggle">
            <input type="checkbox" id="dither" />
            <label for="dither">Floyd–Steinberg dithering</label>
          </div>
          <div class="toggle">
            <input type="checkbox" id="preserveAlpha" />
            <label for="preserveAlpha">Preserve transparency</label>
          </div>
        </div>

        <div class="row">
          <em class="meta">Auto‑converts on image load</em>
          <button id="save" disabled>Save indexed PNG</button>
        </div>

        <div class="row">
          <button id="demo">Load demo image</button>
          <button id="selftest">Run self test</button>
        </div>

        <div class="palette" id="palette"></div>
        <details class="test" id="testPanel">
          <summary>Self-test results</summary>
          <div id="selfTest" class="meta"></div>
        </details>
      </div>
    </section>

    <section class="right card">
      <div class="gallery">
        <div class="panel">
          <h3>Original</h3>
          <div class="body">
            <canvas id="srcCanvas"></canvas>
            <div class="meta" id="srcMeta"></div>
          </div>
        </div>
        <div class="panel">
          <h3>Converted (SMS palette)</h3>
          <div class="body">
            <canvas id="dstCanvas"></canvas>
            <div class="meta" id="dstMeta"></div>
            <div class="meta" id="dstColorsMeta"></div>
            <div class="palette used" id="usedPalette"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="card">
    <div>Palette: Sega Master System (64 colors, RGB levels 0,85,170,255 per channel). Export: true indexed PNG (color type 3) with PLTE. No external deps except a tiny zlib (pako) bundled below.</div>
  </footer>

  <!-- ======= Minimal PNG utilities (CRC32 + chunking + indexed encoder) ======= -->
  <script>
    const CRC_TABLE = new Uint32Array(256); (function(){ for(let n=0;n<256;n++){ let c=n; for(let k=0;k<8;k++) c=(c&1)?(0xEDB88320^(c>>>1)):(c>>>1); CRC_TABLE[n]=c>>>0; } })();
    function crc32(buf, off=0, len=buf.length){ let c=0xFFFFFFFF; for(let i=off;i<off+len;i++) c = CRC_TABLE[(c ^ buf[i]) & 0xFF] ^ (c>>>8); return (c ^ 0xFFFFFFFF)>>>0; }
    const be32 = n => new Uint8Array([n>>>24 & 255, n>>>16 & 255, n>>>8 & 255, n & 255]);
    function chunk(typeStr, data){ const type=new TextEncoder().encode(typeStr); const len=be32(data.length); const out=new Uint8Array(12+data.length); out.set(len,0); out.set(type,4); out.set(data,8); const c=crc32(out,4,4+data.length); out.set(be32(c),8+data.length); return out; }
    function encodeIndexedPNG(indexBytes, width, height, palette, transparency){
      if(palette.length % 3 !== 0) throw new Error('Palette must be 3*N bytes');
      const N = palette.length/3; if(N<1||N>256) throw new Error('Palette entries must be 1..256');
      const sig = new Uint8Array([137,80,78,71,13,10,26,10]);
      const ihdr = new Uint8Array(13);
      ihdr.set(be32(width),0); ihdr.set(be32(height),4);
      ihdr[8]=8; ihdr[9]=3; ihdr[10]=0; ihdr[11]=0; ihdr[12]=0;
      const IHDR = chunk('IHDR', ihdr);
      const PLTE = chunk('PLTE', palette);
      const TRNS = (transparency && transparency.length>0) ? chunk('tRNS', transparency) : null;
      const raw = new Uint8Array(height*(1+width));
      for(let y=0;y<height;y++){ raw[y*(width+1)]=0; raw.set(indexBytes.subarray(y*width,(y+1)*width), y*(width+1)+1); }
      const compressed = window.pako.deflate(raw, {level:0}); // zlib stream
      const IDAT = chunk('IDAT', compressed);
      const IEND = chunk('IEND', new Uint8Array());
      const totalLen = sig.length+IHDR.length+PLTE.length+(TRNS?TRNS.length:0)+IDAT.length+IEND.length;
      const png = new Uint8Array(totalLen);
      let o=0; png.set(sig,o); o+=sig.length; png.set(IHDR,o); o+=IHDR.length; png.set(PLTE,o); o+=PLTE.length; if(TRNS){ png.set(TRNS,o); o+=TRNS.length; } png.set(IDAT,o); o+=IDAT.length; png.set(IEND,o);
      return png;
    }
  </script>

  <!-- ======= Tiny zlib (stored blocks) for PNG IDAT ======= -->
  <script>
    (function(root){
      function adler32(buf){ let a=1,b=0; for(let i=0;i<buf.length;i++){ a=(a+buf[i])%65521; b=(b+a)%65521; } return ((b<<16)>>>0)|(a>>>0); }
      function zlibStore(data){
        const CMF=0x78, FLG=0x01; // 0x7801 => (CMF*256+FLG)%31==0
        const parts=[]; let pos=0; while(pos<data.length){ const len=Math.min(65535,data.length-pos); const isFinal=(pos+len===data.length)?1:0; parts.push(isFinal); parts.push(len&255, (len>>>8)&255, (~len)&255, ((~len)>>>8)&255); for(let i=0;i<len;i++) parts.push(data[pos+i]); pos+=len; }
        const body=new Uint8Array(parts); const ad=adler32(data);
        const out=new Uint8Array(2+body.length+4); out[0]=CMF; out[1]=FLG; out.set(body,2); out[out.length-4]=(ad>>>24)&255; out[out.length-3]=(ad>>>16)&255; out[out.length-2]=(ad>>>8)&255; out[out.length-1]=ad&255; return out;
      }
      root.pako={deflate:zlibStore};
    })(window);
  </script>

  <!-- ======= App logic ======= -->
  <script>
    // Globals assigned in initUI
    let fileInput, drop, saveBtn, demoBtn, selfTestBtn,
        ditherEl, alphaEl, srcCanvas, dstCanvas,
        srcMeta, dstMeta, dstColorsMeta, usedPaletteEl, paletteEl, selfTestEl;

    let current = {width:0,height:0, srcImageData:null, indices:null};

    // Build 64-color SMS palette (levels 0,85,170,255 per channel)
    function buildSMSPalette(){ const steps=[0,85,170,255]; const pal=[]; for(let r of steps){ for(let g of steps){ for(let b of steps){ pal.push({r,g,b}); } } } return pal; }
    const SMS_PALETTE = buildSMSPalette();

    function renderFullPalette(){ paletteEl.innerHTML=''; SMS_PALETTE.forEach(c=>{ const d=document.createElement('div'); d.className='sw'; d.style.background=`rgb(${c.r},${c.g},${c.b})`; paletteEl.appendChild(d); }); }

    const sq = x=>x*x;
    function nearestIndex(r,g,b){ let best=0,bd=Infinity; for(let i=0;i<SMS_PALETTE.length;i++){ const c=SMS_PALETTE[i]; const d=sq(r-c.r)+sq(g-c.g)+sq(b-c.b); if(d<bd){bd=d;best=i;} } return best; }

    function quantizeToSMS(imageData,{dither=false,preserveAlpha=false}={}){
      const {data,width,height}=imageData; const out=new Uint8Array(width*height); const rgba=new Uint8ClampedArray(data);
      for(let y=0;y<height;y++){
        for(let x=0;x<width;x++){
          const i=((y*width+x)<<2); const a=rgba[i+3]; if(preserveAlpha && a===0){ out[y*width+x]=0; continue; }
          const r=rgba[i], g=rgba[i+1], b=rgba[i+2]; const idx=nearestIndex(r,g,b); out[y*width+x]=idx; const nr=SMS_PALETTE[idx].r, ng=SMS_PALETTE[idx].g, nb=SMS_PALETTE[idx].b;
          if(dither){ const er=r-nr, eg=g-ng, eb=b-nb; const add=(x2,y2,fr)=>{ if(x2<0||x2>=width||y2<0||y2>=height) return; const j=((y2*width+x2)<<2); rgba[j]+=er*fr; rgba[j+1]+=eg*fr; rgba[j+2]+=eb*fr; }; add(x+1,y,7/16); add(x-1,y+1,3/16); add(x,y+1,5/16); add(x+1,y+1,1/16); }
        }
      }
      return out;
    }

    function indicesToImageData(indices,width,height){ const out=new ImageData(width,height); for(let y=0;y<height;y++){ for(let x=0;x<width;x++){ const idx=indices[y*width+x]; const o=((y*width+x)<<2); const c=SMS_PALETTE[idx]; out.data[o]=c.r; out.data[o+1]=c.g; out.data[o+2]=c.b; out.data[o+3]=255; } } return out; }

    const rgbToHex = (r,g,b)=>'#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');

    function renderUsedPalette(indices){ usedPaletteEl.innerHTML=''; if(!indices){ dstColorsMeta.textContent=''; return; } const counts=new Array(SMS_PALETTE.length).fill(0); for(let i=0;i<indices.length;i++) counts[indices[i]]++; const used=[]; for(let i=0;i<counts.length;i++) if(counts[i]>0) used.push({idx:i,count:counts[i]}); used.sort((a,b)=>b.count-a.count); const total=indices.length; dstColorsMeta.textContent=`${used.length} unique colors in converted image`; used.forEach(({idx,count})=>{ const c=SMS_PALETTE[idx]; const sw=document.createElement('div'); sw.className='sw used'; sw.style.background=`rgb(${c.r},${c.g},${c.b})`; const pct=((count/total)*100).toFixed(1); sw.title=`Index ${idx} • ${rgbToHex(c.r,c.g,c.b)} • ${count} px (${pct}%)`; usedPaletteEl.appendChild(sw); }); }

    function runConversion(){ if(!current.srcImageData) return; const indices=quantizeToSMS(current.srcImageData,{dither:ditherEl.checked,preserveAlpha:alphaEl.checked}); current.indices=indices; const imgData=indicesToImageData(indices,current.width,current.height); const ctx=dstCanvas.getContext('2d'); ctx.putImageData(imgData,0,0); dstMeta.textContent=`${current.width}×${current.height}px • palette: 64 colors max`; renderUsedPalette(indices); saveBtn.disabled=false; }

    function applySource(imgData,label=''){ srcCanvas.width=imgData.width; srcCanvas.height=imgData.height; dstCanvas.width=imgData.width; dstCanvas.height=imgData.height; const ctx=srcCanvas.getContext('2d'); ctx.clearRect(0,0,srcCanvas.width,srcCanvas.height); ctx.putImageData(imgData,0,0); current={width:imgData.width,height:imgData.height,srcImageData:imgData,indices:null}; srcMeta.textContent=`${imgData.width}×${imgData.height}px${label}`; dstMeta.textContent=''; dstColorsMeta.textContent=''; usedPaletteEl.innerHTML=''; saveBtn.disabled=true; runConversion(); }

    function loadImage(file){ const url=URL.createObjectURL(file); const img=new Image(); img.onload=()=>{ try{ const w=img.naturalWidth,h=img.naturalHeight; const off=document.createElement('canvas'); off.width=w; off.height=h; const g=off.getContext('2d'); g.drawImage(img,0,0); const src=g.getImageData(0,0,w,h); applySource(src); } finally { URL.revokeObjectURL(url); if(fileInput) fileInput.value=''; } }; img.onerror=()=>{ URL.revokeObjectURL(url); alert('Failed to load image.'); if(fileInput) fileInput.value=''; }; img.src=url; }

    function makeDemoImageData(size=96){ const c=document.createElement('canvas'); c.width=c.height=size; const g=c.getContext('2d'); const grd=g.createLinearGradient(0,0,size,size); grd.addColorStop(0,'#ff0080'); grd.addColorStop(.5,'#00ffff'); grd.addColorStop(1,'#202020'); g.fillStyle=grd; g.fillRect(0,0,size,size); g.globalAlpha=.5; g.fillStyle='#000'; for(let y=0;y<size;y+=8){ for(let x=0;x<size;x+=8){ if(((x+y)/8)%2===0) g.fillRect(x,y,8,8); } } g.globalAlpha=1; return g.getImageData(0,0,size,size); }

    function parsePngChunks(png){ const out=[]; let off=8; while(off+8<=png.length){ const len=(png[off]<<24)|(png[off+1]<<16)|(png[off+2]<<8)|png[off+3]; off+=4; const type=String.fromCharCode(png[off],png[off+1],png[off+2],png[off+3]); off+=4; off+=len; off+=4; out.push({type,length:len}); if(type==='IEND') break; } return out; }

    function runSelfTests(){ try{ const bb=document.getElementById('bootBanner'); if(bb) bb.remove(); }catch(_){} const out=[]; const ok=x=>`<span class="ok">✔</span> ${x}`; const bad=x=>`<span class="fail">✖</span> ${x}`;
      const t1=(!!srcCanvas && !!dstCanvas); out.push(`<div>${t1?ok('Canvases present (#srcCanvas, #dstCanvas)'):bad('Canvases missing')}</div>`);
      const t2=(Array.isArray(SMS_PALETTE)&&SMS_PALETTE.length===64); out.push(`<div>${t2?ok('SMS palette length = 64'):bad('Wrong palette length')}</div>`);
      let t3=false; try{ const idx=new Uint8Array([1]); const pal=new Uint8Array(64*3); for(let i=0;i<64;i++){ const c=SMS_PALETTE[i]; pal[i*3]=c.r; pal[i*3+1]=c.g; pal[i*3+2]=c.b; } const png=encodeIndexedPNG(idx,1,1,pal); t3=png&&png.length>50&&png[0]===137&&png[1]===80&&png[2]===78&&png[3]===71; }catch(e){ t3=false; } out.push(`<div>${t3?ok('PNG encoder emits valid signature'):bad('PNG signature invalid')}</div>`);
      let t4=false; try{ const demo=makeDemoImageData(8); const indices=quantizeToSMS(demo,{}); t4=indices.every(v=>v>=0&&v<64); }catch(e){ t4=false; } out.push(`<div>${t4?ok('Quantizer outputs indices in [0..63]'):bad('Quantizer index out of range')}</div>`);
      let t5=false; try{ const demo2=makeDemoImageData(8); current={width:demo2.width,height:demo2.height,srcImageData:demo2,indices:null}; runConversion(); t5=!!(current.indices&&current.indices.length===demo2.width*demo2.height); }catch(e){ t5=false; } out.push(`<div>${t5?ok('Auto-conversion sets indices after load'):bad('Auto-conversion failed')}</div>`);
      let t6=false; try{ const idx=new Uint8Array([1]); const pal=new Uint8Array(64*3); for(let i=0;i<64;i++){ const c=SMS_PALETTE[i]; pal[i*3]=c.r; pal[i*3+1]=c.g; pal[i*3+2]=c.b; } const png=encodeIndexedPNG(idx,1,1,pal); const chunks=parsePngChunks(png); const types=chunks.map(c=>c.type).join(','); const hasAll=['IHDR','PLTE','IDAT','IEND'].every(t=>types.includes(t)); const colorType=png[8+4+4+9]; t6=hasAll&&colorType===3; }catch(e){ t6=false; } out.push(`<div>${t6?ok('PNG has IHDR/PLTE/IDAT/IEND and indexed color type (3)'):bad('PNG chunk layout/color type wrong')}</div>`);
      selfTestEl.innerHTML=out.join(''); document.getElementById('testPanel').open=true; }

    function initUI(){
      // surface runtime errors to the page
      window.onerror = function(msg, src, line, col, err){ try{ const el=document.getElementById('selfTest'); el.innerHTML = `<div class='fail'>Runtime error: ${String(msg)} at ${src||''}:${line||''}:${col||''}</div>` + (el.innerHTML||''); document.getElementById('testPanel').open=true; }catch(_){} };
      console.log('[SMS Converter] init'); document.title = document.title + ' • preview';
      fileInput=document.getElementById('file'); drop=document.getElementById('drop'); saveBtn=document.getElementById('save'); demoBtn=document.getElementById('demo'); selfTestBtn=document.getElementById('selftest'); ditherEl=document.getElementById('dither'); alphaEl=document.getElementById('preserveAlpha'); srcCanvas=document.getElementById('srcCanvas'); dstCanvas=document.getElementById('dstCanvas'); srcMeta=document.getElementById('srcMeta'); dstMeta=document.getElementById('dstMeta'); dstColorsMeta=document.getElementById('dstColorsMeta'); usedPaletteEl=document.getElementById('usedPalette'); paletteEl=document.getElementById('palette'); selfTestEl=document.getElementById('selfTest');
      if(!srcCanvas||!dstCanvas){ console.error('Required canvas elements not found.'); if(selfTestEl){ selfTestEl.innerHTML='<span class="fail">Canvases missing. Check that #srcCanvas and #dstCanvas exist.</span>'; document.getElementById('testPanel').open=true; } return; }
      renderFullPalette();
      fileInput.addEventListener('change',e=>{ const f=e.target.files&&e.target.files[0]; if(f) loadImage(f); });
      ['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault(); e.stopPropagation(); drop.classList.add('drag');}));
      ['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault(); e.stopPropagation(); drop.classList.remove('drag');}));
      drop.addEventListener('drop',e=>{ const f=e.dataTransfer.files&&e.dataTransfer.files[0]; if(f) loadImage(f); });
      const rerunIfReady=()=>{ if(current.srcImageData) runConversion(); }; ditherEl.addEventListener('change',rerunIfReady); alphaEl.addEventListener('change',rerunIfReady);
      saveBtn.addEventListener('click',()=>{ if(!current.indices){ alert('Nothing to save yet. Load an image first.'); return; } const PAL=new Uint8Array(SMS_PALETTE.length*3); for(let i=0;i<SMS_PALETTE.length;i++){ const c=SMS_PALETTE[i]; PAL[i*3]=c.r; PAL[i*3+1]=c.g; PAL[i*3+2]=c.b; } let trns=null; if(alphaEl.checked){ const aSrc=current.srcImageData.data; let anyTransparent=false; for(let i=0;i<aSrc.length;i+=4){ if(aSrc[i+3]===0){ anyTransparent=true; break; } } if(anyTransparent){ trns=new Uint8Array(64); trns[0]=0; for(let i=1;i<64;i++) trns[i]=255; } } const bytes=encodeIndexedPNG(current.indices,current.width,current.height,PAL,trns); const blob=new Blob([bytes],{type:'image/png'}); const a=document.createElement('a'); a.download='converted_sms_indexed.png'; a.href=URL.createObjectURL(blob); document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),5000); });
      demoBtn.addEventListener('click',()=>{ const demo=makeDemoImageData(128); applySource(demo,' (demo)'); });
      selfTestBtn.addEventListener('click',runSelfTests);
      runSelfTests();
    }

    if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded',initUI); } else { initUI(); }
  </script>
</body>
</html>
